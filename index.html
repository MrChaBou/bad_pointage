<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pointage Badminton</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        badminton: {
                            green: '#10B981',
                            red: '#EF4444'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white dark:bg-gray-900 min-h-screen">
    <!-- Dark mode detection -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <div class="max-w-md mx-auto p-4">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">üè∏ Pointage Badminton</h1>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Recherchez votre nom et cochez votre pr√©sence</p>
        </div>

        <!-- Tabs -->
        <div class="flex mb-6 bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
            <button id="pointageTab" class="flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors bg-white dark:bg-gray-700 text-primary shadow-sm">
                Pointage
            </button>
            <button id="journalTab" class="flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                Journal
            </button>
            <button id="adminTab" class="flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                Admin
            </button>
        </div>

        <!-- Pointage Section -->
        <div id="pointageSection">
            <!-- Search Box -->
            <div class="mb-6">
                <label for="searchInput" class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Tapez votre nom ou pr√©nom (2-3 lettres min.)
                </label>
                <input 
                    type="text" 
                    id="searchInput" 
                    class="w-full text-lg p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-800 dark:text-white"
                    placeholder="Ex: Dup, Marie, etc."
                    autocomplete="off"
                    autocapitalize="off"
                >
            </div>

            <!-- Player Display -->
            <div id="playerCard" class="hidden bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6 border-2 border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h3 id="playerName" class="text-xl font-semibold text-gray-900 dark:text-white mb-1"></h3>
                        <p id="playerId" class="text-gray-600 dark:text-gray-400 text-base"></p>
                    </div>
                    <div class="ml-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="presenceCheck" class="sr-only">
                            <div class="relative">
                                <div class="w-12 h-12 bg-gray-300 dark:bg-gray-600 rounded-lg flex items-center justify-center checkbox-unchecked">
                                    <span class="text-gray-500 dark:text-gray-400 text-xl">‚òê</span>
                                </div>
                                <div class="w-12 h-12 bg-badminton-green rounded-lg flex items-center justify-center checkbox-checked hidden">
                                    <span class="text-white text-xl">‚úì</span>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Feedback -->
            <div id="feedback" class="hidden text-center py-4">
                <div class="inline-flex items-center px-6 py-3 bg-badminton-green text-white rounded-lg text-lg font-medium">
                    <span class="mr-2">‚úÖ</span>
                    <span>Pr√©sence enregistr√©e !</span>
                </div>
            </div>

            <!-- Instructions -->
            <div class="text-center text-gray-500 dark:text-gray-400 text-sm mt-8">
                <p>1. Tapez quelques lettres de votre nom</p>
                <p>2. Cliquez sur la case pour pointer votre pr√©sence</p>
                <p>3. L'√©cran se r√©initialise automatiquement</p>
            </div>
            
            <!-- Footer -->
            <div class="text-center text-gray-400 dark:text-gray-500 text-xs mt-8">
                <p>Dev par MrChaBou avec ‚ù§Ô∏è</p>
            </div>
        </div>

        <!-- Journal Section -->
        <div id="journalSection" class="hidden">
            <div class="mb-4 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Journal des pr√©sences</h2>
                <button id="clearJournal" class="text-badminton-red hover:text-red-700 text-sm font-medium">
                    Effacer
                </button>
            </div>
            
            <div id="journalList" class="space-y-3">
                <!-- Journal entries will be added here -->
            </div>
            
            <div id="emptyJournal" class="text-center py-8 text-gray-500 dark:text-gray-400">
                <p>Aucune pr√©sence enregistr√©e</p>
            </div>
            
            <!-- Footer -->
            <div class="text-center text-gray-400 dark:text-gray-500 text-xs mt-8">
                <p>Dev par MrChaBou avec ‚ù§Ô∏è</p>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="adminSection" class="hidden">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">Administration</h2>
            
            <!-- Import Section -->
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6 border border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">üì• Import des joueurs</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    Importez un fichier Excel (.xlsx) avec les colonnes : <strong>Nom</strong>, <strong>Pr√©nom</strong>
                </p>
                
                <div class="mb-4">
                    <input 
                        type="file" 
                        id="importFile" 
                        accept=".xlsx,.xls" 
                        class="hidden"
                    >
                    <button 
                        id="importBtn" 
                        class="w-full bg-primary text-white py-3 px-4 rounded-lg font-medium text-base hover:bg-purple-700 transition-colors"
                    >
                        üìÅ S√©lectionner un fichier Excel
                    </button>
                </div>
                
                <div id="importStatus" class="hidden text-sm font-medium"></div>
                
                <!-- Players Preview -->
                <div id="playersPreview" class="hidden mt-4">
                    <h4 class="font-medium text-gray-900 dark:text-white mb-2">Joueurs actuels (<span id="playersCount">0</span>)</h4>
                    <div id="playersList" class="max-h-40 overflow-y-auto bg-white dark:bg-gray-900 rounded border p-3 text-sm">
                        <!-- Players list will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Planning Update Section -->
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6 border border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">üìã Mise √† jour du planning</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    Importez le planning Excel, choisissez un cr√©neau et une date, puis t√©l√©chargez le planning mis √† jour
                </p>
                
                <!-- Import Planning -->
                <div class="mb-4">
                    <input 
                        type="file" 
                        id="planningFile" 
                        accept=".xlsx,.xls" 
                        class="hidden"
                    >
                    <button 
                        id="planningBtn" 
                        class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium text-base hover:bg-blue-700 transition-colors"
                    >
                        üìÅ Choisir le planning Excel
                    </button>
                </div>


                <div id="planningConfig" class="hidden">

                    <div class="mb-4 space-y-3">

                        <select 

                            id="sheetSelect" 

                            class="w-full text-base p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-white disabled:opacity-50"

                            disabled

                        >

                            <option value="">- Cr√©neau (onglet) -</option>

                        </select>

                        

                        <select 

                            id="dateSelect" 

                            class="w-full text-base p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-white disabled:opacity-50"

                            disabled

                        >

                            <option value="">- Date √† mettre √† jour -</option>

                        </select>

                    </div>

                    

                    <div class="mb-4">

                        <button 

                            id="downloadPlanningBtn" 

                            class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg font-medium text-base hover:bg-purple-700 transition-colors disabled:opacity-50"

                            disabled

                        >

                            üì• T√©l√©charger le planning mis √† jour

                        </button>

                    </div>

                </div>

                

<div id="planningStatus" class="hidden text-sm font-medium"></div>
            </div>

            <!-- Reset Section -->
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">üîÑ R√©initialisation</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    Effacez toutes les donn√©es pour un nouveau cr√©neau
                </p>
                
                <button 
                    id="resetAllBtn" 
                    class="w-full bg-badminton-red text-white py-3 px-4 rounded-lg font-medium text-base hover:bg-red-700 transition-colors"
                >
                    ‚ö†Ô∏è Tout r√©initialiser
                </button>
            </div>
            
            <!-- Footer -->
            <div class="text-center text-gray-400 dark:text-gray-500 text-xs mt-8">
                <p>Dev par MrChaBou avec ‚ù§Ô∏è</p>
            </div>
        </div>
    </div>

    <script>
        // Sample data - will be loaded from storage if available
        let players = [];
        let journalEntries = [];
        let resetTimeout = null;

        // Storage functions
        function savePlayersToStorage() {
            try {
                localStorage.setItem('badminton_players', JSON.stringify(players));
            } catch (e) {
                console.log('Could not save players to storage');
            }
        }

        function loadPlayersFromStorage() {
            try {
                const savedPlayers = localStorage.getItem('badminton_players');
                if (savedPlayers) {
                    players.length = 0;
                    players.push(...JSON.parse(savedPlayers));
                    return true;
                }
            } catch (e) {
                console.log('Could not load players from storage');
            }
            return false;
        }

        function saveJournalToStorage() {
            try {
                localStorage.setItem('badminton_journal', JSON.stringify(journalEntries));
            } catch (e) {
                console.log('Could not save journal to storage');
            }
        }

        function loadJournalFromStorage() {
            try {
                const savedJournal = localStorage.getItem('badminton_journal');
                if (savedJournal) {
                    journalEntries.length = 0;
                    journalEntries.push(...JSON.parse(savedJournal));
                    return true;
                }
            } catch (e) {
                console.log('Could not load journal from storage');
            }
            return false;
        }

        function clearAllStorage() {
            try {
                localStorage.removeItem('badminton_players');
                localStorage.removeItem('badminton_journal');
            } catch (e) {
                console.log('Could not clear storage');
            }
        }

        // Initialize with sample data if no saved data exists
        function initializeDefaultPlayers() {
            if (players.length === 0) {
                const defaultPlayers = [
                    { id: 'B001', nom: 'Dupont', prenom: 'Jean' },
                    { id: 'B002', nom: 'Martin', prenom: 'Marie' },
                    { id: 'B003', nom: 'Durand', prenom: 'Pierre' },
                    { id: 'B004', nom: 'Lefebvre', prenom: 'Sophie' },
                    { id: 'B005', nom: 'Moreau', prenom: 'Luc' },
                    { id: 'B006', nom: 'Simon', prenom: 'Emma' },
                    { id: 'B007', nom: 'Michel', prenom: 'Paul' },
                    { id: 'B008', nom: 'Leroy', prenom: 'Julie' },
                    { id: 'B009', nom: 'Roux', prenom: 'Thomas' },
                    { id: 'B010', nom: 'David', prenom: 'Claire' },
                    { id: 'B011', nom: 'Bertrand', prenom: 'Antoine' },
                    { id: 'B012', nom: 'Petit', prenom: 'Camille' }
                ];
                players.push(...defaultPlayers);
                savePlayersToStorage();
            }
        }

        // DOM elements
        const searchInput = document.getElementById('searchInput');
        const playerCard = document.getElementById('playerCard');
        const playerName = document.getElementById('playerName');
        const playerId = document.getElementById('playerId');
        const presenceCheck = document.getElementById('presenceCheck');
        const feedback = document.getElementById('feedback');
        const pointageTab = document.getElementById('pointageTab');
        const journalTab = document.getElementById('journalTab');
        const adminTab = document.getElementById('adminTab');
        const pointageSection = document.getElementById('pointageSection');
        const journalSection = document.getElementById('journalSection');
        const adminSection = document.getElementById('adminSection');
        const journalList = document.getElementById('journalList');
        const emptyJournal = document.getElementById('emptyJournal');
        const clearJournal = document.getElementById('clearJournal');
        
        // Admin elements
        const importFile = document.getElementById('importFile');
        const importBtn = document.getElementById('importBtn');
        const importStatus = document.getElementById('importStatus');
        const playersPreview = document.getElementById('playersPreview');
        const playersCount = document.getElementById('playersCount');
        const playersList = document.getElementById('playersList');
        const resetAllBtn = document.getElementById('resetAllBtn');
        
        // Planning elements
        const planningFile = document.getElementById('planningFile');
        const planningBtn = document.getElementById('planningBtn');
        const planningConfig = document.getElementById('planningConfig');
        const sheetSelect = document.getElementById('sheetSelect');
        const dateSelect = document.getElementById('dateSelect');
        const downloadPlanningBtn = document.getElementById('downloadPlanningBtn');
        const planningStatus = document.getElementById('planningStatus');
        
        // Planning data
        let planningWorkbook = null;
        let selectedSheetData = null;
        let planningFileName = '';

        let currentPlayer = null;

        // Tab switching
        pointageTab.addEventListener('click', () => {
            switchTab('pointage');
        });

        journalTab.addEventListener('click', () => {
            switchTab('journal');
        });

        adminTab.addEventListener('click', () => {
            switchTab('admin');
        });

        function switchTab(tab) {
            // Reset all tabs
            [pointageTab, journalTab, adminTab].forEach(t => {
                t.classList.remove('bg-white', 'dark:bg-gray-700', 'text-primary', 'shadow-sm');
                t.classList.add('text-gray-600', 'dark:text-gray-400');
            });
            
            // Hide all sections
            [pointageSection, journalSection, adminSection].forEach(s => {
                s.classList.add('hidden');
            });
            
            // Activate selected tab and section
            if (tab === 'pointage') {
                pointageTab.classList.add('bg-white', 'dark:bg-gray-700', 'text-primary', 'shadow-sm');
                pointageTab.classList.remove('text-gray-600', 'dark:text-gray-400');
                pointageSection.classList.remove('hidden');
            } else if (tab === 'journal') {
                journalTab.classList.add('bg-white', 'dark:bg-gray-700', 'text-primary', 'shadow-sm');
                journalTab.classList.remove('text-gray-600', 'dark:text-gray-400');
                journalSection.classList.remove('hidden');
                updateJournalDisplay();
            } else if (tab === 'admin') {
                adminTab.classList.add('bg-white', 'dark:bg-gray-700', 'text-primary', 'shadow-sm');
                adminTab.classList.remove('text-gray-600', 'dark:text-gray-400');
                adminSection.classList.remove('hidden');
                updatePlayersPreview();
            }
        }

        // Search functionality
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();
            
            if (query.length < 2) {
                hidePlayer();
                return;
            }

            const foundPlayer = players.find(player => 
                player.nom.toLowerCase().includes(query) || 
                player.prenom.toLowerCase().includes(query)
            );

            if (foundPlayer) {
                showPlayer(foundPlayer);
            } else {
                hidePlayer();
            }
        });

        function showPlayer(player) {
            currentPlayer = player;
            playerName.textContent = `${player.prenom} ${player.nom}`;
            playerId.textContent = `ID: ${player.id}`;
            playerCard.classList.remove('hidden');
            
            // Reset checkbox state
            presenceCheck.checked = false;
            updateCheckboxDisplay();
        }

        function hidePlayer() {
            currentPlayer = null;
            playerCard.classList.add('hidden');
        }

        // Checkbox functionality
        presenceCheck.addEventListener('change', (e) => {
            if (e.target.checked && currentPlayer) {
                recordPresence(currentPlayer);
                updateCheckboxDisplay();
                showFeedback();
                scheduleReset();
            }
        });

        function updateCheckboxDisplay() {
            const unchecked = document.querySelector('.checkbox-unchecked');
            const checked = document.querySelector('.checkbox-checked');
            
            if (presenceCheck.checked) {
                unchecked.classList.add('hidden');
                checked.classList.remove('hidden');
                playerCard.classList.add('bg-green-50', 'dark:bg-green-900', 'border-badminton-green');
            } else {
                unchecked.classList.remove('hidden');
                checked.classList.add('hidden');
                playerCard.classList.remove('bg-green-50', 'dark:bg-green-900', 'border-badminton-green');
            }
        }

        function recordPresence(player) {
            const now = new Date();
            const entry = {
                timestamp: now.toLocaleString('fr-FR'),
                nom: player.nom,
                prenom: player.prenom,
                id: player.id,
                status: 'Pr√©sent'
            };
            
            journalEntries.unshift(entry); // Add to beginning of array
            saveJournalToStorage(); // Save to storage
        }

        function showFeedback() {
            feedback.classList.remove('hidden');
        }

        function hideFeedback() {
            feedback.classList.add('hidden');
        }

        function scheduleReset() {
            if (resetTimeout) {
                clearTimeout(resetTimeout);
            }
            
            resetTimeout = setTimeout(() => {
                resetForm();
            }, 3000);
        }

        function resetForm() {
            searchInput.value = '';
            hidePlayer();
            hideFeedback();
            currentPlayer = null;
            searchInput.focus();
        }

        // Journal functionality
        function updateJournalDisplay() {
            if (journalEntries.length === 0) {
                emptyJournal.classList.remove('hidden');
                journalList.innerHTML = '';
                return;
            }
            
            emptyJournal.classList.add('hidden');
            
            journalList.innerHTML = journalEntries.map(entry => `
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 dark:text-white">${entry.prenom} ${entry.nom}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">ID: ${entry.id}</p>
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-badminton-green text-white rounded">
                                ‚úì ${entry.status}
                            </span>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${entry.timestamp}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        clearJournal.addEventListener('click', () => {
            showConfirmDialog('√ätes-vous s√ªr de vouloir effacer tout le journal ?', () => {
                journalEntries = [];
                saveJournalToStorage(); // Save to storage
                updateJournalDisplay();
            });
        });

        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full">
                    <p class="text-gray-700 dark:text-gray-300 mb-4 text-base">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-base" onclick="this.closest('.fixed').remove()">Annuler</button>
                        <button class="px-4 py-2 bg-badminton-red text-white hover:bg-red-600 rounded text-base" onclick="this.closest('.fixed').remove(); (${onConfirm.toString()})()">Confirmer</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Admin functionality
        importBtn.addEventListener('click', () => {
            importFile.click();
        });

        importFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                importExcelFile(file);
            }
        });

        // Planning functionality
        planningBtn.addEventListener('click', () => {
            planningFile.click();
        });

        planningFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                planningFileName = file.name;
                resetPlanningUI();
                importPlanningFile(file);
            } else {
                planningFileName = '';
                resetPlanningUI();
                planningWorkbook = null;
                selectedSheetData = null;
            }
        });

        sheetSelect.addEventListener('change', () => {
            readDatesFromSheet();
        });

        dateSelect.addEventListener('change', () => {
            updateDownloadPlanningState();
        });

        downloadPlanningBtn.addEventListener('click', () => {
            downloadUpdatedPlanning();
        });

        resetAllBtn.addEventListener('click', () => {
            showConfirmDialog('‚ö†Ô∏è Cette action va effacer tous les joueurs et toutes les pr√©sences. √ätes-vous s√ªr ?', () => {
                resetAllData();
            });
        });

        function importExcelFile(file) {
            showImportStatus('üìÑ Lecture du fichier...', 'text-blue-600');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // Get first worksheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        showImportStatus('‚ö†Ô∏è Le fichier est vide', 'text-badminton-red');
                        return;
                    }
                    
                    // Validate columns (only nom and prenom required)
                    const requiredColumns = ['nom', 'prenom'];
                    const firstRow = jsonData[0];
                    const fileColumns = Object.keys(firstRow).map(k => k.toLowerCase());
                    
                    const missingColumns = requiredColumns.filter(col => 
                        !fileColumns.some(fc => fc.includes(col))
                    );
                    
                    if (missingColumns.length > 0) {
                        showImportStatus(`‚ö†Ô∏è Colonnes manquantes: ${missingColumns.join(', ')}`, 'text-badminton-red');
                        return;
                    }
                    
                    // Map data (auto-generate ID)
                    const newPlayers = jsonData.map((row, index) => {
                        const rowKeys = Object.keys(row);
                        const nomKey = rowKeys.find(k => k.toLowerCase().includes('nom'));
                        const prenomKey = rowKeys.find(k => k.toLowerCase().includes('prenom'));
                        
                        return {
                            nom: row[nomKey] || '',
                            prenom: row[prenomKey] || '',
                            id: `B${String(index + 1).padStart(3, '0')}`
                        };
                    }).filter(player => player.nom && player.prenom);
                    
                    if (newPlayers.length === 0) {
                        showImportStatus('‚ö†Ô∏è Aucun joueur valide trouv√©', 'text-badminton-red');
                        return;
                    }
                    
                    // Replace current players
                    players.length = 0;
                    players.push(...newPlayers);
                    savePlayersToStorage(); // Save to storage
                    
                    showImportStatus(`‚úÖ ${newPlayers.length} joueurs import√©s avec succ√®s`, 'text-badminton-green');
                    updatePlayersPreview();
                    
                    // Reset form
                    resetForm();
                    
                } catch (error) {
                    console.log('Import error:', error);
                    showImportStatus('‚ùå Erreur lors de la lecture du fichier', 'text-badminton-red');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function showImportStatus(message, className) {
            importStatus.textContent = message;
            importStatus.className = `text-sm font-medium ${className}`;
            importStatus.classList.remove('hidden');
            
            setTimeout(() => {
                importStatus.classList.add('hidden');
            }, 5000);
        }

        function updatePlayersPreview() {
            playersCount.textContent = players.length;
            
            if (players.length === 0) {
                playersPreview.classList.add('hidden');
                return;
            }
            
            playersPreview.classList.remove('hidden');
            playersList.innerHTML = players.map(player => 
                `<div class="flex justify-between py-1 border-b border-gray-200 dark:border-gray-700 last:border-0">
                    <span class="text-gray-900 dark:text-white">${player.prenom} ${player.nom}</span>
                    <span class="text-gray-500 dark:text-gray-400 text-xs">${player.id}</span>
                </div>`
            ).join('');
        }

        function exportPresencesToExcel() {
            if (journalEntries.length === 0) {
                showExportStatus('‚ö†Ô∏è Aucune pr√©sence √† exporter', 'text-badminton-red');
                return;
            }
            
            showExportStatus('üìä G√©n√©ration du fichier...', 'text-blue-600');
            
            try {
                // Prepare data for export
                const exportData = journalEntries.map(entry => ({
                    'Horodatage': entry.timestamp,
                    'Nom': entry.nom,
                    'Pr√©nom': entry.prenom,
                    'Statut': entry.status
                }));
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Auto-size columns
                const colWidths = [
                    { wch: 20 }, // Horodatage
                    { wch: 15 }, // Nom
                    { wch: 15 }, // Pr√©nom
                    { wch: 10 }  // Statut
                ];
                ws['!cols'] = colWidths;
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, "Pr√©sences");
                
                // Generate filename with current date
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
                const filename = `presences_badminton_${dateStr}_${timeStr}.xlsx`;
                
                // Generate blob for iOS sharing
                const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
                const blob = new Blob([wbout], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
                
                // Try to use Web Share API (iOS)
                if (navigator.share) {
                    const file = new File([blob], filename, {
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    });
                    
                    navigator.share({
                        files: [file],
                        title: 'Export Pr√©sences Badminton'
                    }).then(() => {
                        showExportStatus(`‚úÖ Fichier partag√©: ${filename}`, 'text-badminton-green');
                    }).catch(() => {
                        // Fallback to download
                        downloadFile(blob, filename);
                    });
                } else {
                    // Fallback to download
                    downloadFile(blob, filename);
                }
                
            } catch (error) {
                console.log('Export error:', error);
                showExportStatus('‚ùå Erreur lors de l\'export', 'text-badminton-red');
            }
        }

        function downloadFile(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showExportStatus(`‚úÖ Fichier t√©l√©charg√©: ${filename}`, 'text-badminton-green');
        }

        function showExportStatus(message, className) {
            exportStatus.textContent = message;
            exportStatus.className = `mt-3 text-sm font-medium ${className}`;
            exportStatus.classList.remove('hidden');
            
            setTimeout(() => {
                exportStatus.classList.add('hidden');
            }, 5000);
        }

        function resetAllData() {
            // Clear all data
            players.length = 0;
            journalEntries.length = 0;
            
            // Clear storage
            clearAllStorage();
            
            // Reinitialize with default data
            initializeDefaultPlayers();
            
            // Reset form
            resetForm();
            
            // Update displays
            updatePlayersPreview();
            updateJournalDisplay();
            
            // Show confirmation
            showImportStatus('üîÑ Toutes les donn√©es ont √©t√© effac√©es', 'text-blue-600');
        }

        // Initialize app on load
        function initializeApp() {
            // Try to load saved data
            const playersLoaded = loadPlayersFromStorage();
            const journalLoaded = loadJournalFromStorage();
            
            // If no players data exists, use default sample data
            if (!playersLoaded) {
                initializeDefaultPlayers();
            }
            
            // Update displays
            updatePlayersPreview();
            updateJournalDisplay();
            resetPlanningUI();
            
            // Focus search input
            searchInput.focus();
        }

        // Planning functionality implementation
        function importPlanningFile(file) {
            showPlanningStatus('üìñ Lecture du planning...', 'text-blue-600');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    planningWorkbook = XLSX.read(data, { type: 'array', cellStyles: true, cellDates: true });
                    
                    showPlanningStatus('‚úÖ Planning charg√© - ' + planningWorkbook.SheetNames.length + ' onglet(s) trouv√©(s)', 'text-badminton-green');
                    
                    planningConfig.classList.remove('hidden');
                    readPlanningSheets();
                    updateDownloadPlanningState();
                    
                } catch (error) {
                    console.log('Planning import error:', error);
                    planningWorkbook = null;
                    selectedSheetData = null;
                    resetPlanningUI();
                    showPlanningStatus('‚ùå Erreur lors de la lecture du planning', 'text-badminton-red');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function readPlanningSheets() {
            sheetSelect.innerHTML = '<option value="">- Cr√©neau (onglet) -</option>';
            
            if (!planningWorkbook) {
                showPlanningStatus('‚ö†Ô∏è Aucun planning charg√©', 'text-badminton-red');
                sheetSelect.disabled = true;
                sheetSelect.classList.add('opacity-50');
                selectedSheetData = null;
                updateDownloadPlanningState();
                return;
            }
            
            if (!planningWorkbook.SheetNames || planningWorkbook.SheetNames.length === 0) {
                showPlanningStatus('‚ö†Ô∏è Aucun onglet disponible', 'text-badminton-red');
                sheetSelect.disabled = true;
                sheetSelect.classList.add('opacity-50');
                selectedSheetData = null;
                updateDownloadPlanningState();
                return;
            }
            
            planningWorkbook.SheetNames.forEach(sheetName => {
                const option = document.createElement('option');
                option.value = sheetName;
                option.textContent = sheetName;
                sheetSelect.appendChild(option);
            });
            
            sheetSelect.disabled = false;
            sheetSelect.classList.remove('opacity-50');
            
            if (!sheetSelect.value && planningWorkbook.SheetNames.length > 0) {
                sheetSelect.value = planningWorkbook.SheetNames[0];
            }
            
            readDatesFromSheet();
        }

        
function readDatesFromSheet() {
    dateSelect.innerHTML = '<option value="">- Date √† mettre √† jour -</option>';
    dateSelect.disabled = true;
    dateSelect.classList.add('opacity-50');
    selectedSheetData = null;

    if (!planningWorkbook) {
        updateDownloadPlanningState();
        return;
    }

    const sheetName = sheetSelect.value;
    if (!sheetName) {
        updateDownloadPlanningState();
        return;
    }

    try {
        const worksheet = planningWorkbook.Sheets[sheetName];
        if (!worksheet) {
            showPlanningStatus('‚ùå Onglet introuvable', 'text-badminton-red');
            updateDownloadPlanningState();
            return;
        }

        selectedSheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true });

        if (!selectedSheetData || selectedSheetData.length === 0) {
            showPlanningStatus('‚ö†Ô∏è Onglet vide', 'text-badminton-red');
            updateDownloadPlanningState();
            return;
        }

        const columnCandidates = new Map();
        const scanLimit = Math.min(selectedSheetData.length, 20);

        for (let rowIndex = 0; rowIndex < scanLimit; rowIndex++) {
            const row = selectedSheetData[rowIndex];
            if (!row) continue;

            row.forEach((cell, colIndex) => {
                const info = extractDateInfo(cell);
                if (!info) {
                    return;
                }
                const score = info.sortValue ?? rowIndex;
                const existing = columnCandidates.get(colIndex);
                if (!existing || score >= existing.score) {
                    columnCandidates.set(colIndex, {
                        columnIndex: colIndex,
                        rowIndex,
                        dateLabel: info.label,
                        score
                    });
                }
            });
        }

        const dateColumns = Array.from(columnCandidates.values())
            .sort((a, b) => a.columnIndex - b.columnIndex);

        if (dateColumns.length === 0) {
            showPlanningStatus('‚ö†Ô∏è Aucune date d√©tect√©e dans cet onglet', 'text-badminton-red');
            updateDownloadPlanningState();
            return;
        }

        dateColumns.sort((a, b) => a.columnIndex - b.columnIndex);

        dateColumns.forEach(dateCol => {
            const option = document.createElement('option');
            option.value = `${dateCol.columnIndex}|${dateCol.rowIndex}`;
            option.textContent = dateCol.dateLabel;
            dateSelect.appendChild(option);
        });

        dateSelect.disabled = false;
        dateSelect.classList.remove('opacity-50');

        if (!dateSelect.value && dateColumns.length > 0) {
            dateSelect.value = `${dateColumns[0].columnIndex}|${dateColumns[0].rowIndex}`;
        }

        updateDownloadPlanningState();
        showPlanningStatus(`‚úÖ ${dateColumns.length} date(s) d√©tect√©e(s)`, 'text-badminton-green');

    } catch (error) {
        console.log('Date reading error:', error);
        showPlanningStatus('‚ùå Erreur lors de la lecture des dates', 'text-badminton-red');
        updateDownloadPlanningState();
    }
}

function extractDateInfo(value) {
    if (value === undefined || value === null || value === '') {
        return null;
    }

    if (typeof value === 'number' && typeof XLSX !== 'undefined' && XLSX.SSF && XLSX.SSF.parse_date_code) {
        const parsed = XLSX.SSF.parse_date_code(value);
        if (parsed) {
            const jsDate = new Date(Date.UTC(parsed.y, parsed.m - 1, parsed.d));
            if (!Number.isNaN(jsDate.getTime())) {
                return { label: formatDateLabel(jsDate), sortValue: jsDate.getTime() };
            }
        }
    }

    if (value instanceof Date && !Number.isNaN(value.getTime())) {
        return { label: formatDateLabel(value), sortValue: value.getTime() };
    }

    const str = value.toString().trim();
    if (!str) {
        return null;
    }

    const normalized = normalizeDateCandidate(str);
    const datePatterns = [
        /\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4}/,
        /\d{1,2}[-\/]\w{3,4}[-\/]?\d{0,4}/,
        /\w{3,9}\s+\d{1,2}/,
        /\d{1,2}\s+\w{3,9}/,
        /^\d{2}-\w{3,4}$/
    ];
    const monthKeywords = ['jan', 'fev', 'mar', 'avr', 'mai', 'juin', 'juil', 'aout', 'sep', 'oct', 'nov', 'dec'];

    const hasMonth = monthKeywords.some(keyword => normalized.includes(keyword));
    const matchesPattern = datePatterns.some(pattern => pattern.test(normalized));

    if (hasMonth || matchesPattern) {
        return { label: cleanDateLabel(str), sortValue: null };
    }

    return null;
}

function formatDateLabel(date) {
    try {
        return date.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'short'
        })
        .replace(/\./g, '')
        .replace(/\s+/g, '-')
        .replace(/-$/, '')
        .trim();
    } catch (error) {
        return date.toISOString().split('T')[0];
    }
}

function cleanDateLabel(text) {
    return text.replace(/\s+/g, ' ').trim().replace(/\s/g, '-');
}

function normalizeDateCandidate(str) {
    return str.toString().toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\-\/\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
}

function isDateLike(value) {
            return Boolean(extractDateInfo(value));
        }

        
function computePresenceColumn(columnIndex, headerRowIndex) {
            if (!selectedSheetData) {
                return null;
            }
            
            const dateText = selectedSheetData[headerRowIndex][columnIndex];
            
            let nameColumnIndex = -1;
            let firstNameColumnIndex = -1;
            
            for (let rowIndex = 0; rowIndex < Math.min(5, selectedSheetData.length); rowIndex++) {
                const row = selectedSheetData[rowIndex];
                if (row) {
                    row.forEach((cell, colIndex) => {
                        if (cell && typeof cell === 'string') {
                            const cellLower = cell.toLowerCase();
                            if (cellLower.includes('nom') && nameColumnIndex === -1) {
                                nameColumnIndex = colIndex;
                            }
                            if (cellLower.includes('prenom') && firstNameColumnIndex === -1) {
                                firstNameColumnIndex = colIndex;
                            }
                        }
                    });
                }
            }
            
            const columnData = [];
            columnData.push([dateText]);
            
            for (let rowIndex = headerRowIndex + 1; rowIndex < selectedSheetData.length; rowIndex++) {
                const row = selectedSheetData[rowIndex];
                if (!row || row.length === 0) {
                    columnData.push(['']);
                    continue;
                }
                
                const lastName = nameColumnIndex >= 0 ? row[nameColumnIndex] : '';
                const firstName = firstNameColumnIndex >= 0 ? row[firstNameColumnIndex] : '';
                
                if (!lastName && !firstName) {
                    columnData.push(['']);
                    continue;
                }
                
                const isPresent = journalEntries.some(entry => {
                    const entryName = normalizeString(entry.nom);
                    const entryFirstName = normalizeString(entry.prenom);
                    const sheetName = normalizeString(lastName);
                    const sheetFirstName = normalizeString(firstName);
                    
                    return (entryName === sheetName && entryFirstName === sheetFirstName) ||
                           (entryName === sheetName && !firstName) ||
                           (entryFirstName === sheetFirstName && !lastName);
                });
                
                columnData.push([isPresent ? 'V' : '']);
            }
            
            return { columnData, dateText };
        }

        function normalizeString(str) {
            if (!str) return '';
            return str.toString().toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove accents
                .replace(/[^\w]/g, '') // Remove non-word characters
                .trim();
        }

        function downloadUpdatedPlanning() {
            if (!planningWorkbook) {
                showPlanningStatus('‚ö†Ô∏è Aucun planning charg√©', 'text-badminton-red');
                return;
            }
            
            const selectedSheet = sheetSelect.value;
            const selectedDate = dateSelect.value;
            
            if (!selectedSheet || !selectedDate) {
                showPlanningStatus('‚ö†Ô∏è S√©lectionnez un cr√©neau et une date', 'text-badminton-red');
                return;
            }
            
            const [columnIndex, headerRowIndex] = selectedDate.split('|').map(Number);
            
            showPlanningStatus('‚öôÔ∏è Mise √† jour du planning...', 'text-blue-600');
            
            try {
                const result = computePresenceColumn(columnIndex, headerRowIndex);
                if (!result || !result.columnData) {
                    showPlanningStatus('‚ùå Impossible de g√©n√©rer la colonne', 'text-badminton-red');
                    return;
                }
                
                applyColumnToWorksheet(selectedSheet, columnIndex, headerRowIndex, result.columnData);
                
                const filename = planningFileName || 'planning_mis_a_jour.xlsx';
                XLSX.writeFile(planningWorkbook, filename);
                
                showPlanningStatus('‚úÖ Planning t√©l√©charg√©: ' + filename, 'text-badminton-green');
                
            } catch (error) {
                console.log('Planning update error:', error);
                showPlanningStatus('‚ùå Erreur lors de la mise √† jour du planning', 'text-badminton-red');
            }
        }
        



function applyColumnToWorksheet(sheetName, columnIndex, headerRowIndex, columnData) {
    const worksheet = planningWorkbook.Sheets[sheetName];
    if (!worksheet) {
        throw new Error('Sheet not found');
    }

    const lastRowIndex = headerRowIndex + columnData.length - 1;
    let range;
    if (worksheet['!ref']) {
        range = XLSX.utils.decode_range(worksheet['!ref']);
    } else {
        range = { s: { c: 0, r: 0 }, e: { c: columnIndex, r: lastRowIndex } };
    }

    range.e.c = Math.max(range.e.c, columnIndex);
    range.e.r = Math.max(range.e.r, lastRowIndex);

    const headerAddress = XLSX.utils.encode_cell({ c: columnIndex, r: headerRowIndex });
    const headerCell = worksheet[headerAddress];
    const baseStyle = headerCell && headerCell.s ? headerCell.s : undefined;

    columnData.forEach((row, offset) => {
        const value = row[0] ?? '';
        const targetRow = headerRowIndex + offset;
        const cellAddress = XLSX.utils.encode_cell({ c: columnIndex, r: targetRow });
        const existingCell = worksheet[cellAddress];
        const cell = existingCell ? { ...existingCell } : {};
        const inheritedStyle = existingCell && existingCell.s ? existingCell.s : baseStyle;
        let appliedValue = value;

        if (value === '' || value === null) {
            cell.v = '';
            cell.t = 's';
            delete cell.w;
            worksheet[cellAddress] = cell;
        } else {
            cell.v = value;
            cell.t = typeof value === 'number' ? 'n' : 's';
            if (cell.t === 'n') {
                /* keep existing formatted display */
            }
            worksheet[cellAddress] = cell;
        }

        if (inheritedStyle && worksheet[cellAddress]) {
            worksheet[cellAddress].s = inheritedStyle;
        }

        if (!selectedSheetData[targetRow]) {
            selectedSheetData[targetRow] = [];
        }
        selectedSheetData[targetRow][columnIndex] = appliedValue;
    });

    worksheet['!ref'] = XLSX.utils.encode_range(range);
}

function updateDownloadPlanningState() {
            const ready = Boolean(planningWorkbook && sheetSelect.value && dateSelect.value);
            downloadPlanningBtn.disabled = !ready;
            if (ready) {
                downloadPlanningBtn.classList.remove('opacity-50');
            } else {
                downloadPlanningBtn.classList.add('opacity-50');
            }
        }
        
        function resetPlanningUI() {
            planningConfig.classList.add('hidden');
            
            sheetSelect.innerHTML = '<option value="">- Cr√©neau (onglet) -</option>';
            sheetSelect.disabled = true;
            sheetSelect.classList.add('opacity-50');
            
            dateSelect.innerHTML = '<option value="">- Date √† mettre √† jour -</option>';
            dateSelect.disabled = true;
            dateSelect.classList.add('opacity-50');
            
            downloadPlanningBtn.disabled = true;
            downloadPlanningBtn.classList.add('opacity-50');
            
            selectedSheetData = null;
            updateDownloadPlanningState();
        }

        function showPlanningStatus(message, className) {
            planningStatus.textContent = message;
            planningStatus.className = `text-sm font-medium ${className}`;
            planningStatus.classList.remove('hidden');
            
            setTimeout(() => {
                planningStatus.classList.add('hidden');
            }, 5000);
        }

        // Start the app when DOM is loaded
        initializeApp();
    </script>
</body>
</html>
