<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pointage Badminton</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#5D5CDE',
            badminton: {
              green: '#10B981',
              red: '#EF4444'
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-white dark:bg-gray-900 min-h-screen">
  <!-- Dark mode detection -->
  <script>
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (event.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    });
  </script>

  <div class="max-w-md mx-auto p-4">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">üè∏ Pointage Badminton</h1>
      <p class="text-gray-600 dark:text-gray-400 text-sm">Recherchez votre nom et cochez votre pr√©sence</p>
    </div>

    <!-- Tabs -->
    <div class="flex mb-6 bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
      <button id="pointageTab" class="flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors bg-white dark:bg-gray-700 text-primary shadow-sm">
        Pointage
      </button>
      <button id="journalTab" class="flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
        Journal
      </button>
      <button id="adminTab" class="flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
        Admin
      </button>
    </div>

    <!-- Pointage Section -->
    <div id="pointageSection">
      <!-- Search Box -->
      <div class="mb-6">
        <label for="searchInput" class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-2">
          Tapez votre nom ou pr√©nom (2-3 lettres min.)
        </label>
        <input
          type="text"
          id="searchInput"
          class="w-full text-lg p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-800 dark:text-white"
          placeholder="Ex: Dup, Marie, etc."
          autocomplete="off"
          autocapitalize="off"
        >
      </div>

      <!-- Player Display -->
      <div id="playerCard" class="hidden bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6 border-2 border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <h3 id="playerName" class="text-xl font-semibold text-gray-900 dark:text-white mb-1"></h3>
            <p id="playerId" class="text-gray-600 dark:text-gray-400 text-base"></p>
          </div>
          <div class="ml-4">
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" id="presenceCheck" class="sr-only">
              <div class="relative">
                <div class="w-12 h-12 bg-gray-300 dark:bg-gray-600 rounded-lg flex items-center justify-center checkbox-unchecked">
                  <span class="text-gray-500 dark:text-gray-400 text-xl">‚òê</span>
                </div>
                <div class="w-12 h-12 bg-badminton-green rounded-lg flex items-center justify-center checkbox-checked hidden">
                  <span class="text-white text-xl">‚úì</span>
                </div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Feedback -->
      <div id="feedback" class="hidden text-center py-4">
        <div class="inline-flex items-center px-6 py-3 bg-badminton-green text-white rounded-lg text-lg font-medium">
          <span class="mr-2">‚úÖ</span>
          <span>Pr√©sence enregistr√©e !</span>
        </div>
      </div>

      <!-- Instructions -->
      <div class="text-center text-gray-500 dark:text-gray-400 text-sm mt-8">
        <p>1. Tapez quelques lettres de votre nom</p>
        <p>2. Cliquez sur la case pour pointer votre pr√©sence</p>
        <p>3. L'√©cran se r√©initialise automatiquement</p>
      </div>

      <!-- Footer -->
      <div class="mt-8 text-center text-xs text-gray-400 dark:text-gray-500">
        Dev par MrChaBou avec ‚ù§Ô∏è
      </div>
    </div>

    <!-- Journal Section -->
    <div id="journalSection" class="hidden">
      <div class="mb-4 flex justify-between items-center">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Journal des pr√©sences</h2>
        <button id="clearJournal" class="text-badminton-red hover:text-red-700 text-sm font-medium">
          Effacer
        </button>
      </div>

      <div id="journalList" class="space-y-3">
        <!-- Journal entries will be added here -->
      </div>

      <div id="emptyJournal" class="text-center py-8 text-gray-500 dark:text-gray-400">
        <p>Aucune pr√©sence enregistr√©e</p>
      </div>

      <!-- Footer -->
      <div class="mt-8 text-center text-xs text-gray-400 dark:text-gray-500">
        Dev par MrChaBou avec ‚ù§Ô∏è
      </div>
    </div>

    <!-- Admin Section -->
    <div id="adminSection" class="hidden">
      <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">Administration</h2>

      <!-- Import Section -->
      <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6 border border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">üì• Import des joueurs</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
          Importez un fichier Excel (.xlsx) avec les colonnes : <strong>Nom</strong>, <strong>Pr√©nom</strong>
        </p>

        <div class="mb-4">
          <input type="file" id="importFile" accept=".xlsx,.xls" class="hidden">
          <button id="importBtn" class="w-full bg-primary text-white py-3 px-4 rounded-lg font-medium text-base hover:bg-purple-700 transition-colors">
            üìÅ S√©lectionner un fichier Excel
          </button>
        </div>

        <div id="importStatus" class="hidden text-sm font-medium"></div>

        <!-- Players Preview -->
        <div id="playersPreview" class="hidden mt-4">
          <h4 class="font-medium text-gray-900 dark:text-white mb-2">Joueurs actuels (<span id="playersCount">0</span>)</h4>
          <div id="playersList" class="max-h-40 overflow-y-auto bg-white dark:bg-gray-900 rounded border p-3 text-sm">
            <!-- Players list -->
          </div>
        </div>
      </div>

      <!-- Export Section -->
      <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6 border border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">üì§ Export des pr√©sences</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
          Exportez le journal des pr√©sences au format Excel (.xlsx)
        </p>

        <button id="exportBtn" class="w-full bg-badminton-green text-white py-3 px-4 rounded-lg font-medium text-base hover:bg-green-700 transition-colors">
          üíæ Exporter les pr√©sences
        </button>

        <div id="exportStatus" class="hidden mt-3 text-sm font-medium"></div>
      </div>

      <!-- Update Planning Section -->
      <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6 border border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">üß© Mise √† jour du planning</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
          Importez le fichier Excel du planning (avec colonnes <strong>NOM</strong>, <strong>Pr√©nom</strong> et les <strong>dates</strong> en ent√™te de colonnes, en vraies dates Excel).
        </p>

        <input id="templateFile" type="file" accept=".xlsx,.xls" class="hidden">
        <div class="grid gap-3 sm:grid-cols-2">
          <button id="chooseTemplateBtn"
                  class="bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 text-gray-800 dark:text-gray-200 py-3 px-4 rounded-lg font-medium hover:bg-gray-50">
            üìÅ Choisir le planning Excel
          </button>

          <button id="updatePlanningBtn"
                  class="bg-primary text-white py-3 px-4 rounded-lg font-medium hover:bg-purple-700">
            ‚úÖ Mettre √† jour le planning
          </button>
        </div>

        <div id="updateStatus" class="hidden mt-3 text-sm font-medium"></div>
      </div>

      <!-- Reset Section -->
      <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">üîÑ R√©initialisation</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
          Effacez toutes les donn√©es pour un nouveau cr√©neau
        </p>

        <button id="resetAllBtn" class="w-full bg-badminton-red text-white py-3 px-4 rounded-lg font-medium text-base hover:bg-red-700 transition-colors">
          ‚ö†Ô∏è Tout r√©initialiser
        </button>
      </div>

      <!-- Footer -->
      <div class="mt-8 text-center text-xs text-gray-400 dark:text-gray-500">
        Dev par MrChaBou avec ‚ù§Ô∏è
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Donn√©es et stockage
    // =========================
    let players = [];
    let journalEntries = [];
    let resetTimeout = null;

    function savePlayersToStorage() {
      try { localStorage.setItem('badminton_players', JSON.stringify(players)); } catch {}
    }
    function loadPlayersFromStorage() {
      try {
        const saved = localStorage.getItem('badminton_players');
        if (saved) { players.length = 0; players.push(...JSON.parse(saved)); return true; }
      } catch {}
      return false;
    }
    function saveJournalToStorage() {
      try { localStorage.setItem('badminton_journal', JSON.stringify(journalEntries)); } catch {}
    }
    function loadJournalFromStorage() {
      try {
        const saved = localStorage.getItem('badminton_journal');
        if (saved) { journalEntries.length = 0; journalEntries.push(...JSON.parse(saved)); return true; }
      } catch {}
      return false;
    }
    function clearAllStorage() {
      try {
        localStorage.removeItem('badminton_players');
        localStorage.removeItem('badminton_journal');
      } catch {}
    }

    function initializeDefaultPlayers() {
      if (players.length === 0) {
        const defaultPlayers = [
          { id: 'B001', nom: 'Dupont', prenom: 'Jean' },
          { id: 'B002', nom: 'Martin', prenom: 'Marie' },
          { id: 'B003', nom: 'Durand', prenom: 'Pierre' },
          { id: 'B004', nom: 'Lefebvre', prenom: 'Sophie' },
          { id: 'B005', nom: 'Moreau', prenom: 'Luc' },
          { id: 'B006', nom: 'Simon', prenom: 'Emma' },
          { id: 'B007', nom: 'Michel', prenom: 'Paul' },
          { id: 'B008', nom: 'Leroy', prenom: 'Julie' },
          { id: 'B009', nom: 'Roux', prenom: 'Thomas' },
          { id: 'B010', nom: 'David', prenom: 'Claire' },
          { id: 'B011', nom: 'Bertrand', prenom: 'Antoine' },
          { id: 'B012', nom: 'Petit', prenom: 'Camille' }
        ];
        players.push(...defaultPlayers);
        savePlayersToStorage();
      }
    }

    // =========================
    // DOM
    // =========================
    const searchInput    = document.getElementById('searchInput');
    const playerCard     = document.getElementById('playerCard');
    const playerName     = document.getElementById('playerName');
    const playerId       = document.getElementById('playerId');
    const presenceCheck  = document.getElementById('presenceCheck');
    const feedback       = document.getElementById('feedback');
    const pointageTab    = document.getElementById('pointageTab');
    const journalTab     = document.getElementById('journalTab');
    const adminTab       = document.getElementById('adminTab');
    const pointageSection= document.getElementById('pointageSection');
    const journalSection = document.getElementById('journalSection');
    const adminSection   = document.getElementById('adminSection');
    const journalList    = document.getElementById('journalList');
    const emptyJournal   = document.getElementById('emptyJournal');
    const clearJournal   = document.getElementById('clearJournal');

    // Admin elements
    const importFile     = document.getElementById('importFile');
    const importBtn      = document.getElementById('importBtn');
    const importStatus   = document.getElementById('importStatus');
    const playersPreview = document.getElementById('playersPreview');
    const playersCount   = document.getElementById('playersCount');
    const playersList    = document.getElementById('playersList');
    const exportBtn      = document.getElementById('exportBtn');
    const exportStatus   = document.getElementById('exportStatus');
    const resetAllBtn    = document.getElementById('resetAllBtn');

    // Planning update elements
    const templateFile       = document.getElementById('templateFile');
    const chooseTemplateBtn  = document.getElementById('chooseTemplateBtn');
    const updatePlanningBtn  = document.getElementById('updatePlanningBtn');
    const updateStatus       = document.getElementById('updateStatus');

    let currentPlayer = null;

    // =========================
    // Tabs
    // =========================
    pointageTab.addEventListener('click', () => switchTab('pointage'));
    journalTab.addEventListener('click',  () => switchTab('journal'));
    adminTab.addEventListener('click',    () => switchTab('admin'));

    function switchTab(tab) {
      [pointageTab, journalTab, adminTab].forEach(t => {
        t.classList.remove('bg-white','dark:bg-gray-700','text-primary','shadow-sm');
        t.classList.add('text-gray-600','dark:text-gray-400');
      });
      [pointageSection, journalSection, adminSection].forEach(s => s.classList.add('hidden'));

      if (tab === 'pointage') {
        pointageTab.classList.add('bg-white','dark:bg-gray-700','text-primary','shadow-sm');
        pointageTab.classList.remove('text-gray-600','dark:text-gray-400');
        pointageSection.classList.remove('hidden');
      } else if (tab === 'journal') {
        journalTab.classList.add('bg-white','dark:bg-gray-700','text-primary','shadow-sm');
        journalTab.classList.remove('text-gray-600','dark:text-gray-400');
        journalSection.classList.remove('hidden');
        updateJournalDisplay();
      } else {
        adminTab.classList.add('bg-white','dark:bg-gray-700','text-primary','shadow-sm');
        adminTab.classList.remove('text-gray-600','dark:text-gray-400');
        adminSection.classList.remove('hidden');
        updatePlayersPreview();
      }
    }

    // =========================
    // Recherche & Pointage
    // =========================
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.trim().toLowerCase();
      if (query.length < 2) { hidePlayer(); return; }
      const foundPlayer = players.find(p =>
        p.nom.toLowerCase().includes(query) || p.prenom.toLowerCase().includes(query)
      );
      foundPlayer ? showPlayer(foundPlayer) : hidePlayer();
    });

    function showPlayer(player) {
      currentPlayer = player;
      playerName.textContent = `${player.prenom} ${player.nom}`;
      playerId.textContent = `ID: ${player.id}`;
      playerCard.classList.remove('hidden');
      presenceCheck.checked = false;
      updateCheckboxDisplay();
    }

    function hidePlayer() {
      currentPlayer = null;
      playerCard.classList.add('hidden');
    }

    presenceCheck.addEventListener('change', (e) => {
      if (e.target.checked && currentPlayer) {
        recordPresence(currentPlayer);
        updateCheckboxDisplay();
        showFeedback();
        scheduleReset();
      }
    });

    function updateCheckboxDisplay() {
      const unchecked = document.querySelector('.checkbox-unchecked');
      const checked   = document.querySelector('.checkbox-checked');
      if (presenceCheck.checked) {
        unchecked.classList.add('hidden');
        checked.classList.remove('hidden');
        playerCard.classList.add('bg-green-50','dark:bg-green-900','border-badminton-green');
      } else {
        unchecked.classList.remove('hidden');
        checked.classList.add('hidden');
        playerCard.classList.remove('bg-green-50','dark:bg-green-900','border-badminton-green');
      }
    }

    function recordPresence(player) {
      const now   = new Date();
      const yyyy  = now.getFullYear();
      const mm    = String(now.getMonth()+1).padStart(2,'0');
      const dd    = String(now.getDate()).padStart(2,'0');

      const entry = {
        timestamp: now.toLocaleString('fr-FR'),
        dateKey: `${yyyy}-${mm}-${dd}`,     // cl√© date normalis√©e pour l‚ÄôExcel cible
        nom: player.nom,
        prenom: player.prenom,
        id: player.id,
        status: 'Pr√©sent'
      };

      journalEntries.unshift(entry);
      saveJournalToStorage();
    }

    function showFeedback(){ feedback.classList.remove('hidden'); }
    function hideFeedback(){ feedback.classList.add('hidden'); }
    function scheduleReset(){
      if (resetTimeout) clearTimeout(resetTimeout);
      resetTimeout = setTimeout(() => resetForm(), 3000);
    }
    function resetForm(){
      searchInput.value = '';
      hidePlayer();
      hideFeedback();
      currentPlayer = null;
      searchInput.focus();
    }

    // =========================
    // Journal
    // =========================
    function updateJournalDisplay() {
      if (journalEntries.length === 0) {
        emptyJournal.classList.remove('hidden');
        journalList.innerHTML = '';
        return;
      }
      emptyJournal.classList.add('hidden');
      journalList.innerHTML = journalEntries.map(entry => `
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <h4 class="font-semibold text-gray-900 dark:text-white">${entry.prenom} ${entry.nom}</h4>
              <p class="text-sm text-gray-600 dark:text-gray-400">ID: ${entry.id}</p>
            </div>
            <div class="text-right">
              <span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-badminton-green text-white rounded">
                ‚úì ${entry.status}
              </span>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${entry.timestamp}</p>
            </div>
          </div>
        </div>
      `).join('');
    }

    clearJournal.addEventListener('click', () => {
      showConfirmDialog('√ätes-vous s√ªr de vouloir effacer tout le journal ?', () => {
        journalEntries = [];
        saveJournalToStorage();
        updateJournalDisplay();
      });
    });

    function showConfirmDialog(message, onConfirm) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full">
          <p class="text-gray-700 dark:text-gray-300 mb-4 text-base">${message}</p>
          <div class="flex justify-end space-x-3">
            <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-base" onclick="this.closest('.fixed').remove()">Annuler</button>
            <button class="px-4 py-2 bg-badminton-red text-white hover:bg-red-600 rounded text-base" onclick="this.closest('.fixed').remove(); (${onConfirm.toString()})()">Confirmer</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // =========================
    // Admin : import / export / reset
    // =========================
    importBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', (e) => { const f = e.target.files[0]; if (f) importExcelFile(f); });
    exportBtn.addEventListener('click', () => exportPresencesToExcel());
    resetAllBtn.addEventListener('click', () => {
      showConfirmDialog('‚ö†Ô∏è Cette action va effacer tous les joueurs et toutes les pr√©sences. √ätes-vous s√ªr ?', () => resetAllData());
    });

    function importExcelFile(file) {
      showImportStatus('üìä Lecture du fichier...', 'text-blue-600');
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          if (jsonData.length === 0) { showImportStatus('‚ùå Le fichier est vide', 'text-badminton-red'); return; }

          const required = ['nom','prenom'];
          const fileColumns = Object.keys(jsonData[0]).map(k => k.toLowerCase());
          const missing = required.filter(col => !fileColumns.some(fc => fc.includes(col)));
          if (missing.length > 0) { showImportStatus(`‚ùå Colonnes manquantes: ${missing.join(', ')}`, 'text-badminton-red'); return; }

          const newPlayers = jsonData.map((row, index) => {
            const rowKeys = Object.keys(row);
            const nomKey = rowKeys.find(k => k.toLowerCase().includes('nom'));
            const prenomKey = rowKeys.find(k => k.toLowerCase().includes('prenom'));
            return { nom: row[nomKey] || '', prenom: row[prenomKey] || '', id: `B${String(index+1).padStart(3,'0')}` };
          }).filter(p => p.nom && p.prenom);

          if (newPlayers.length === 0) { showImportStatus('‚ùå Aucun joueur valide trouv√©', 'text-badminton-red'); return; }

          players.length = 0; players.push(...newPlayers); savePlayersToStorage();
          showImportStatus(`‚úÖ ${newPlayers.length} joueurs import√©s avec succ√®s`, 'text-badminton-green');
          updatePlayersPreview(); resetForm();
        } catch (err) {
          console.log('Import error:', err);
          showImportStatus('‚ùå Erreur lors de la lecture du fichier', 'text-badminton-red');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function showImportStatus(message, className) {
      importStatus.textContent = message;
      importStatus.className = `text-sm font-medium ${className}`;
      importStatus.classList.remove('hidden');
      setTimeout(() => importStatus.classList.add('hidden'), 5000);
    }

    function updatePlayersPreview() {
      playersCount.textContent = players.length;
      if (players.length === 0) { playersPreview.classList.add('hidden'); return; }
      playersPreview.classList.remove('hidden');
      playersList.innerHTML = players.map(p => `
        <div class="flex justify-between py-1 border-b border-gray-200 dark:border-gray-700 last:border-0">
          <span class="text-gray-900 dark:text-white">${p.prenom} ${p.nom}</span>
          <span class="text-gray-500 dark:text-gray-400 text-xs">${p.id}</span>
        </div>
      `).join('');
    }

    function exportPresencesToExcel() {
      if (journalEntries.length === 0) { showExportStatus('‚ùå Aucune pr√©sence √† exporter', 'text-badminton-red'); return; }
      showExportStatus('üìä G√©n√©ration du fichier...', 'text-blue-600');
      try {
        const exportData = journalEntries.map(e => ({
          'Horodatage': e.timestamp,
          'Nom': e.nom,
          'Pr√©nom': e.prenom,
          'Statut': e.status
        }));
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(exportData);
        ws['!cols'] = [{wch:20},{wch:15},{wch:15},{wch:10}];
        XLSX.utils.book_append_sheet(wb, ws, "Pr√©sences");

        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        const timeStr = now.toTimeString().split(' ')[0].replace(/:/g,'-');
        const filename = `presences_badminton_${dateStr}_${timeStr}.xlsx`;

        const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
        const blob = new Blob([wbout], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});

        if (navigator.share) {
          const file = new File([blob], filename, {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
          navigator.share({ files:[file], title:'Export Pr√©sences Badminton' })
            .then(()=>showExportStatus(`‚úÖ Fichier partag√©: ${filename}`, 'text-badminton-green'))
            .catch(()=>downloadFile(blob, filename));
        } else {
          downloadFile(blob, filename);
        }
      } catch (err) {
        console.log('Export error:', err);
        showExportStatus('‚ùå Erreur lors de l\'export', 'text-badminton-red');
      }
    }

    function downloadFile(blob, filename) {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none'; a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      window.URL.revokeObjectURL(url); document.body.removeChild(a);
      showExportStatus(`‚úÖ Fichier t√©l√©charg√©: ${filename}`, 'text-badminton-green');
    }

    function showExportStatus(message, className) {
      exportStatus.textContent = message;
      exportStatus.className = `mt-3 text-sm font-medium ${className}`;
      exportStatus.classList.remove('hidden');
      setTimeout(() => exportStatus.classList.add('hidden'), 5000);
    }

    function resetAllData() {
      players.length = 0; journalEntries.length = 0; clearAllStorage();
      initializeDefaultPlayers(); resetForm();
      updatePlayersPreview(); updateJournalDisplay();
      showImportStatus('üîÑ Toutes les donn√©es ont √©t√© effac√©es', 'text-blue-600');
    }

    // =========================
    // MISE √Ä JOUR PLANNING XLSX
    // =========================
    // Normalisation noms
    function normalizeName(s) {
      return (s || "").toString()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, " ")
        .trim().toUpperCase();
    }

    // Cl√© date depuis ent√™te Excel
    function dateKeyFromExcelCell(cell) {
      if (cell && typeof cell.v === "number") {
        const d = XLSX.SSF.parse_date_code(cell.v);
        if (d && d.y && d.m && d.d) {
          const mm = String(d.m).padStart(2, "0");
          const dd = String(d.d).padStart(2, "0");
          return `${d.y}-${mm}-${dd}`;
        }
      }
      if (cell && typeof cell.v === "string") {
        const m = /(\d{2})[\/\-\.](\d{2})[\/\-\.](\d{4})/.exec(cell.v);
        if (m) {
          const [_, dd, mm, yyyy] = m;
          return `${yyyy}-${mm}-${dd}`;
        }
      }
      return null;
    }

    // Set des pr√©sences: "NOM|PRENOM|YYYY-MM-DD"
    function buildPresenceSetFromJournal(entries) {
      const set = new Set();
      entries.forEach(e => {
        if ((e.status || e.Statut) !== "Pr√©sent") return;
        const nom    = normalizeName(e.nom || e.Nom);
        const prenom = normalizeName(e.prenom || e.Pr√©nom || e["Pr√©nom"]);
        const dkey   = e.dateKey; // d√©j√† normalis√©e
        if (nom && prenom && dkey) set.add(`${nom}|${prenom}|${dkey}`);
      });
      return set;
    }

    let selectedTemplateFile = null;
    chooseTemplateBtn.addEventListener('click', () => templateFile.click());
    templateFile.addEventListener('change', (e) => {
      selectedTemplateFile = e.target.files[0] || null;
      showUpdateStatus(
        selectedTemplateFile ? `‚úÖ Fichier charg√©: ${selectedTemplateFile.name}` : '‚ùå Aucun fichier',
        selectedTemplateFile ? 'text-badminton-green' : 'text-badminton-red'
      );
    });

    updatePlanningBtn.addEventListener('click', async () => {
      if (!selectedTemplateFile) {
        showUpdateStatus('‚ùå Choisissez d‚Äôabord le fichier planning', 'text-badminton-red'); return;
      }
      if (journalEntries.length === 0) {
        showUpdateStatus('‚ùå Le journal des pr√©sences est vide', 'text-badminton-red'); return;
      }
      showUpdateStatus('‚è≥ Traitement en cours...', 'text-blue-600');
      try {
        await updatePlanningExcel(selectedTemplateFile, journalEntries);
      } catch (e) {
        console.error(e);
        showUpdateStatus('‚ùå Erreur pendant la mise √† jour du planning', 'text-badminton-red');
      }
    });

    function showUpdateStatus(msg, cls) {
      updateStatus.textContent = msg;
      updateStatus.className = `mt-3 text-sm font-medium ${cls}`;
      updateStatus.classList.remove('hidden');
    }

    async function updatePlanningExcel(file, entries) {
      const data = new Uint8Array(await file.arrayBuffer());
      const wb = XLSX.read(data, { type: 'array', cellDates: false, cellNF: true, cellText: true });
      const sheetName = wb.SheetNames[0]; // adapte si besoin
      const ws = wb.Sheets[sheetName];

      const range = XLSX.utils.decode_range(ws['!ref']);
      let headerRow = -1, colNom = -1, colPrenom = -1;

      // 1) Trouver la ligne d'ent√™tes
      for (let r = range.s.r; r <= Math.min(range.s.r + 10, range.e.r); r++) {
        let foundNom = -1, foundPrenom = -1;
        for (let c = range.s.c; c <= range.e.c; c++) {
          const addr = XLSX.utils.encode_cell({ r, c });
          const cell = ws[addr];
          const txt = (cell && cell.v ? cell.v.toString() : "").trim().toUpperCase();
          if (txt === "NOM") foundNom = c;
          if (txt === "PR√âNOM" || txt === "PRENOM") foundPrenom = c;
        }
        if (foundNom !== -1 && foundPrenom !== -1) {
          headerRow = r; colNom = foundNom; colPrenom = foundPrenom; break;
        }
      }
      if (headerRow === -1) { showUpdateStatus("‚ùå Colonnes 'NOM' et 'Pr√©nom' introuvables", 'text-badminton-red'); return; }

      // 2) Colonnes date
      const dateCols = [];
      for (let c = colPrenom + 1; c <= range.e.c; c++) {
        const addr = XLSX.utils.encode_cell({ r: headerRow, c });
        const cell = ws[addr];
        const key = dateKeyFromExcelCell(cell);
        if (key) dateCols.push({ c, key });
      }
      if (dateCols.length === 0) { showUpdateStatus("‚ùå Aucune date valide d√©tect√©e en ent√™te", 'text-badminton-red'); return; }

      // 3) Index des lignes par NOM|PRENOM
      const rowIndex = new Map();
      for (let r = headerRow + 1; r <= range.e.r; r++) {
        const addrNom = XLSX.utils.encode_cell({ r, c: colNom });
        const addrPre = XLSX.utils.encode_cell({ r, c: colPrenom });
        const nom = normalizeName(ws[addrNom]?.v);
        const prenom = normalizeName(ws[addrPre]?.v);
        if (nom || prenom) rowIndex.set(`${nom}|${prenom}`, r);
      }

      // 4) Set des pr√©sences
      const presenceSet = buildPresenceSetFromJournal(entries);

      // 5) √âcritures
      let writes = 0;
      presenceSet.forEach(key => {
        const [nom, prenom, dkey] = key.split("|");
        const row = rowIndex.get(`${nom}|${prenom}`);
        if (!row) return;
        const dc = dateCols.find(d => d.key === dkey);
        if (!dc) return;
        const addr = XLSX.utils.encode_cell({ r: row, c: dc.c });
        ws[addr] = { t: 's', v: 'Pr√©sent' };
        writes++;
      });

      if (writes === 0) showUpdateStatus("‚ÑπÔ∏è Aucune correspondance (noms/dates) trouv√©e dans le planning.", 'text-blue-600');
      else              showUpdateStatus(`‚úÖ ${writes} case(s) mise(s) √† jour`, 'text-badminton-green');

      // 6) T√©l√©charger le planning mis √† jour
      const out = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([out], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      downloadFile(blob, `planning_mis_a_jour_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // =========================
    // Init
    // =========================
    function initializeApp() {
      const playersLoaded = loadPlayersFromStorage();
      const journalLoaded = loadJournalFromStorage();
      if (!playersLoaded) initializeDefaultPlayers();
      updatePlayersPreview();
      updateJournalDisplay();
      searchInput.focus();
    }
    initializeApp();
  </script>
</body>
</html>
